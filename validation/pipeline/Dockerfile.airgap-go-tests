# Dockerfile for Airgap Go Testing
# Extends validation Dockerfile with Tofu, Ansible, AWS CLI, and gotestsum for test execution

ARG TOFU_VERSION=1.10.7

FROM --platform=linux/amd64 registry.suse.com/bci/golang:1.25

ARG TOFU_VERSION

# Install runtime dependencies
RUN apk add --no-cache \
    bash \
    curl \
    git \
    openssh-client \
    python3 \
    py3-pip \
    ca-certificates \
    ansible \
    && rm -rf /var/cache/apk/*

# Install OpenTofu
RUN curl -Lo /tmp/tofu.tar.gz "https://github.com/opentofu/opentofu/releases/download/v${TOFU_VERSION}/tofu_${TOFU_VERSION}_linux_amd64.tar.gz" \
    && tar -xzf /tmp/tofu.tar.gz -C /usr/local/bin/ \
    && rm /tmp/tofu.tar.gz \
    && chmod +x /usr/local/bin/tofu

# Install AWS CLI
RUN pip3 install --no-cache-dir --break-system-packages awscli

# Install gotestsum for JUnit reporting
# Note: Go is expected to be available from the base image (Dockerfile.validation)
ENV GOBIN=/usr/local/bin
RUN go install gotest.tools/gotestsum@latest
ENV GOBIN=

# Create working directory
WORKDIR /workspace

# Verify installations
RUN tofu version && \
    ansible --version && \
    aws --version && \
    gotestsum --version

# Default to sh shell (compatible with alpine and docker run sh -c)
CMD ["/bin/sh"]
